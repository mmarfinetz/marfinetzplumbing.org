<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Tracking System Test Suite - Enhanced</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .config-section {
            background: #fffbe6;
            border: 2px solid #d4b106;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .test-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        .log-output {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-healthy { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-pending { background: #ffc107; }
        #debug-panel {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 400px;
            background: white;
            border: 2px solid #333;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .test-results {
            margin-top: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .test-pass { background: #d4edda; color: #155724; }
        .test-fail { background: #f8d7da; color: #721c24; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .endpoint-input {
            width: 400px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .local-note {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Lead Tracking System Test Suite - Enhanced</h1>
    
    <!-- Configuration Section -->
    <div class="config-section">
        <h2>API Configuration</h2>
        <p>Configure the API endpoint for testing:</p>
        <div>
            <label>
                <input type="radio" name="endpoint-type" value="railway" checked onchange="updateEndpoint()">
                Railway URL (Production)
            </label>
            <label style="margin-left: 20px;">
                <input type="radio" name="endpoint-type" value="production" onchange="updateEndpoint()">
                Custom Domain (not configured)
            </label>
            <label style="margin-left: 20px;">
                <input type="radio" name="endpoint-type" value="local" onchange="updateEndpoint()">
                Local Development
            </label>
        </div>
        <div id="railway-input" style="display: block; margin-top: 10px;">
            <label>Railway URL: 
                <input type="text" id="railway-url" class="endpoint-input" 
                       placeholder="https://your-app.railway.app" 
                       value="https://mmwcontractingorg-production.up.railway.app" onchange="updateEndpoint()">
            </label>
        </div>
        <div style="margin-top: 10px;">
            <strong>Current Endpoint:</strong> <span id="current-endpoint">https://mmwcontractingorg-production.up.railway.app</span>
        </div>
    </div>

    <!-- Local Development Note -->
    <div class="local-note" id="local-note" style="display: none;">
        <h3>Local Development Mode</h3>
        <p>To test locally, start the API server:</p>
        <pre>cd api/lead-tracking
npm install
npm start</pre>
        <p>The local server will run on http://localhost:3001</p>
    </div>
    
    <!-- Debug Panel -->
    <div id="debug-panel">
        <h3>Live Tracking Data</h3>
        <div class="metric">
            <span>Session ID:</span>
            <span id="session-id">-</span>
        </div>
        <div class="metric">
            <span>Lead Score:</span>
            <span id="lead-score">0</span>
        </div>
        <div class="metric">
            <span>Page Views:</span>
            <span id="page-views">0</span>
        </div>
        <div class="metric">
            <span>Events Tracked:</span>
            <span id="events-count">0</span>
        </div>
        <div class="metric">
            <span>Time on Site:</span>
            <span id="time-on-site">0s</span>
        </div>
        <div class="metric">
            <span>API Status:</span>
            <span id="api-status">
                <span class="status-indicator status-pending"></span>
                Checking...
            </span>
        </div>
        <div style="margin-top: 15px;">
            <h4>Recent Events</h4>
            <div id="recent-events" style="max-height: 200px; overflow-y: auto; font-size: 11px;">
                <em>No events yet</em>
            </div>
        </div>
    </div>

    <!-- API Health Check -->
    <div class="test-section">
        <h2>1. Backend API Health Check</h2>
        <p>Test the API endpoint availability and response</p>
        <button class="test-button" onclick="testAPIHealth()">Test API Health</button>
        <button class="test-button" onclick="testTrackingEndpoint()">Test Tracking Endpoint</button>
        <button class="test-button" onclick="testCORS()">Test CORS Configuration</button>
        <div id="api-test-results" class="log-output" style="display:none;"></div>
    </div>

    <!-- Frontend Tracking Tests -->
    <div class="test-section">
        <h2>2. Frontend Tracking Tests</h2>
        <p>Simulate user behaviors to test tracking functionality</p>
        
        <h3>Behavior Simulation</h3>
        <button class="test-button" onclick="simulateEmergencyClick()">Simulate Emergency Click (+30 pts)</button>
        <button class="test-button" onclick="simulatePhoneClick()">Simulate Phone Click (+25 pts)</button>
        <button class="test-button" onclick="simulateFormEngagement()">Simulate Form Start (+20 pts)</button>
        <button class="test-button" onclick="simulateMultiplePageViews()">Simulate 3+ Page Views (+10 pts)</button>
        
        <h3>Time-Based Scoring</h3>
        <button class="test-button" onclick="checkTimeBasedScoring()">Check Current Time Score</button>
        
        <div id="tracking-test-results" class="log-output" style="display:none;"></div>
    </div>

    <!-- Integration Tests -->
    <div class="test-section">
        <h2>3. Full Integration Test</h2>
        <p>Test the complete flow from frontend tracking to backend API</p>
        <button class="test-button" onclick="runIntegrationTest().catch(e => console.error('Integration test error:', e))">Run Integration Test</button>
        <div id="integration-results" class="test-results"></div>
    </div>

    <!-- Manual Testing Elements -->
    <div class="test-section">
        <h2>4. Manual Test Elements</h2>
        <p>Elements for manual interaction testing</p>
        
        <!-- Test phone link -->
        <p>Test Phone Link: <a href="tel:814-273-6315" id="test-phone">Call 814-273-6315</a></p>
        
        <!-- Test form -->
        <form id="test-form">
            <label>
                Name: <input type="text" name="name" id="test-input">
            </label>
            <label>
                Email: <input type="email" name="email">
            </label>
            <button type="submit">Submit Test Form</button>
        </form>
        
        <!-- Emergency button -->
        <button id="emergency" class="test-button" style="background: red;">Emergency Service</button>
    </div>

    <!-- Load Testing -->
    <div class="test-section">
        <h2>5. Load Testing</h2>
        <p>Test API performance under load</p>
        <label>
            Number of requests: 
            <input type="number" id="load-test-count" value="10" min="1" max="100">
        </label>
        <button class="test-button" onclick="runLoadTest()">Run Load Test</button>
        <div id="load-test-results" class="log-output" style="display:none;"></div>
    </div>

    <!-- Lead Tracker Script -->
    <script>
        // Create a modified lead tracker for testing
        (function() {
            'use strict';

            // Configuration
            window.leadTrackerConfig = {
                apiEndpoint: 'https://mmwcontractingorg-production.up.railway.app',
                sessionKey: 'mp_session_' + Date.now(),
                trackingInterval: 30000,
                debugMode: true
            };

            // Include the lead tracker logic
            class LeadTracker {
                constructor(config) {
                    this.config = config;
                    this.session = {
                        id: this.generateSessionId(),
                        startTime: Date.now(),
                        pageViews: [],
                        events: [],
                        score: 0,
                        lastActivity: Date.now()
                    };
                    
                    this.scoreModifiers = {
                        time: {
                            afterHours: 20,
                            weekend: 10,
                            businessHours: 5
                        },
                        behavior: {
                            emergencyClick: 30,
                            phoneClick: 25,
                            contactFormStart: 20,
                            multipleServiceViews: 15,
                            testimonialRead: 10,
                            timeOnSite2Min: 15,
                            pagesViewed3Plus: 10
                        },
                        intent: {
                            returnVisitor: 15,
                            directEmergencyNav: 25,
                            emergencySearchKeywords: 20
                        }
                    };

                    this.init();
                }

                init() {
                    this.trackPageView();
                    this.setupEventListeners();
                    this.startTimeTracking();
                    this.detectVisitorInfo();
                    
                    if (this.isReturnVisitor()) {
                        this.updateScore('intent', 'returnVisitor');
                    }
                }

                generateSessionId() {
                    return 'xxxx-xxxx-xxxx'.replace(/[x]/g, () => 
                        (Math.random() * 16 | 0).toString(16)
                    );
                }

                setupEventListeners() {
                    this.trackElementClicks(['#emergency', '.emergency-window', '.emergency-call-button'], 'emergencyClick');
                    this.trackElementClicks(['[href^="tel:"]', '.phone-number'], 'phoneClick');
                    this.trackFormEngagement();
                    window.addEventListener('beforeunload', () => this.sendData(true));
                }

                trackElementClicks(selectors, eventType) {
                    selectors.forEach(selector => {
                        document.addEventListener('click', (e) => {
                            if (e.target.matches(selector) || e.target.closest(selector)) {
                                this.recordEvent(eventType, {
                                    element: selector,
                                    text: e.target.textContent.substring(0, 50)
                                });
                                
                                if (this.scoreModifiers.behavior[eventType]) {
                                    this.updateScore('behavior', eventType);
                                }
                            }
                        });
                    });
                }

                trackFormEngagement() {
                    const formElements = ['input', 'textarea', 'select'];
                    let formStarted = false;

                    formElements.forEach(tag => {
                        document.addEventListener('focus', (e) => {
                            if (e.target.matches(tag) && !formStarted) {
                                formStarted = true;
                                this.recordEvent('contactFormStart', {
                                    field: e.target.name || e.target.id
                                });
                                this.updateScore('behavior', 'contactFormStart');
                            }
                        }, true);
                    });
                }

                trackPageView() {
                    const pageData = {
                        url: window.location.href,
                        title: document.title,
                        referrer: document.referrer,
                        timestamp: Date.now()
                    };

                    this.session.pageViews.push(pageData);
                    this.recordEvent('pageView', pageData);

                    if (this.session.pageViews.length >= 3) {
                        this.updateScore('behavior', 'pagesViewed3Plus');
                    }
                }

                startTimeTracking() {
                    this.checkTimeBasedScoring();
                    
                    setInterval(() => {
                        const timeOnSite = (Date.now() - this.session.startTime) / 1000;
                        
                        if (timeOnSite > 120 && !this.session.events.find(e => e.type === 'timeOnSite2Min')) {
                            this.recordEvent('timeOnSite2Min', { seconds: Math.round(timeOnSite) });
                            this.updateScore('behavior', 'timeOnSite2Min');
                        }

                        this.sendData();
                    }, this.config.trackingInterval);
                }

                checkTimeBasedScoring() {
                    const now = new Date();
                    const hour = now.getHours();
                    const day = now.getDay();

                    if (hour < 8 || hour >= 18) {
                        this.updateScore('time', 'afterHours');
                    } else {
                        this.updateScore('time', 'businessHours');
                    }

                    if (day === 0 || day === 6) {
                        this.updateScore('time', 'weekend');
                    }
                }

                detectVisitorInfo() {
                    this.session.visitor = {
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        screenSize: `${screen.width}x${screen.height}`,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        referrer: document.referrer,
                        device: this.getDeviceType()
                    };
                }

                getDeviceType() {
                    const ua = navigator.userAgent;
                    if (/tablet|ipad|playbook|silk/i.test(ua)) return 'tablet';
                    if (/mobile|iphone|ipod|android|blackberry|opera|mini|windows\\sce|palm|smartphone|iemobile/i.test(ua)) return 'mobile';
                    return 'desktop';
                }

                isReturnVisitor() {
                    try {
                        const stored = sessionStorage.getItem('mp_return');
                        if (stored) return true;
                        sessionStorage.setItem('mp_return', '1');
                        return false;
                    } catch (e) {
                        return false;
                    }
                }

                updateScore(category, modifier) {
                    const points = this.scoreModifiers[category][modifier] || 0;
                    this.session.score = Math.min(100, this.session.score + points);
                    
                    this.recordEvent('scoreUpdate', {
                        category,
                        modifier,
                        points,
                        newScore: this.session.score
                    });

                    this.checkAlertTriggers();
                }

                checkAlertTriggers() {
                    const score = this.session.score;
                    let alertLevel = null;

                    if (score >= 80) {
                        alertLevel = 'immediate';
                    } else if (score >= 60) {
                        alertLevel = 'high_priority';
                    } else if (score >= 40) {
                        alertLevel = 'standard';
                    }

                    if (alertLevel && !this.session.alertSent) {
                        this.session.alertLevel = alertLevel;
                        this.sendData(true);
                        this.session.alertSent = true;
                    }
                }

                recordEvent(type, data = {}) {
                    const event = {
                        type,
                        timestamp: Date.now(),
                        data,
                        url: window.location.href
                    };

                    this.session.events.push(event);
                    
                    if (this.config.debugMode) {
                        console.log('Lead Tracker Event:', event);
                        updateRecentEvents(event);
                    }
                }

                async sendData(immediate = false) {
                    if (!immediate && this.session.events.length < 2) return;

                    const payload = {
                        pageUrl: window.location.href,
                        referrer: document.referrer,
                        timestamp: Date.now(),
                        sessionData: this.session,
                        userAgent: navigator.userAgent,
                        screenResolution: `${screen.width}x${screen.height}`,
                        language: navigator.language,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    };

                    try {
                        const response = await fetch(`${this.config.apiEndpoint}/track`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Session-ID': this.session.id
                            },
                            body: JSON.stringify(payload)
                        });

                        if (this.config.debugMode) {
                            console.log('Lead data sent:', response.status);
                        }
                    } catch (error) {
                        if (this.config.debugMode) {
                            console.error('Failed to send lead data:', error);
                        }
                    }
                }
            }

            // Don't initialize tracker here - wait for endpoint configuration
            window.LeadTrackerClass = LeadTracker;
        })();
    </script>
    
    <script>
        // Test configuration
        let API_ENDPOINT = 'https://mmwcontractingorg-production.up.railway.app';
        const LOCAL_API = 'http://localhost:3001';
        
        // Helper functions
        function updateEndpoint() {
            const endpointType = document.querySelector('input[name="endpoint-type"]:checked').value;
            const railwayInput = document.getElementById('railway-input');
            const localNote = document.getElementById('local-note');
            
            railwayInput.style.display = 'none';
            localNote.style.display = 'none';
            
            switch(endpointType) {
                case 'production':
                    railwayInput.style.display = 'none';
                    API_ENDPOINT = 'https://api.marfinetzplumbing.org';
                    break;
                case 'railway':
                    railwayInput.style.display = 'block';
                    const railwayUrl = document.getElementById('railway-url').value;
                    API_ENDPOINT = railwayUrl || 'https://mmwcontractingorg-production.up.railway.app';
                    break;
                case 'local':
                    railwayInput.style.display = 'none';
                    API_ENDPOINT = LOCAL_API;
                    localNote.style.display = 'block';
                    break;
            }
            
            document.getElementById('current-endpoint').textContent = API_ENDPOINT;
            
            // Reinitialize lead tracker with new endpoint
            if (window.LeadTrackerClass) {
                window.leadTrackerConfig.apiEndpoint = API_ENDPOINT;
                window.leadTracker = new window.LeadTrackerClass(window.leadTrackerConfig);
            }
            
            // Re-run health check
            testAPIHealth();
        }
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function updateDebugPanel() {
            if (window.leadTracker) {
                document.getElementById('session-id').textContent = window.leadTracker.session.id;
                document.getElementById('lead-score').textContent = window.leadTracker.session.score;
                document.getElementById('page-views').textContent = window.leadTracker.session.pageViews.length;
                document.getElementById('events-count').textContent = window.leadTracker.session.events.length;
                
                const timeOnSite = Math.floor((Date.now() - window.leadTracker.session.startTime) / 1000);
                document.getElementById('time-on-site').textContent = `${timeOnSite}s`;
            }
        }

        function updateRecentEvents(event) {
            const eventsDiv = document.getElementById('recent-events');
            const eventHTML = `<div style="margin-bottom: 5px; padding: 5px; background: #f0f0f0;">
                <strong>${event.type}</strong> (score: ${window.leadTracker.session.score})
                ${event.data.points ? `<span style="color: green;">+${event.data.points}</span>` : ''}
            </div>`;
            eventsDiv.innerHTML = eventHTML + eventsDiv.innerHTML;
            
            // Keep only last 10 events
            const events = eventsDiv.children;
            while (events.length > 10) {
                eventsDiv.removeChild(events[events.length - 1]);
            }
        }

        // Update debug panel every second
        setInterval(updateDebugPanel, 1000);

        // Test functions
        async function testAPIHealth() {
            const results = document.getElementById('api-test-results');
            results.innerHTML = '';
            
            try {
                log('api-test-results', `Testing API health endpoint at ${API_ENDPOINT}...`);
                
                const response = await fetch(API_ENDPOINT + '/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('api-test-results', `API Health Check Passed: ${JSON.stringify(data, null, 2)}`, 'success');
                    
                    document.getElementById('api-status').innerHTML = 
                        '<span class="status-indicator status-healthy"></span>Healthy';
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                log('api-test-results', `API Health Check Failed: ${error.message}`, 'error');
                document.getElementById('api-status').innerHTML = 
                    '<span class="status-indicator status-error"></span>Error';
                
                if (error.message.includes('Failed to fetch')) {
                    log('api-test-results', 'Note: This could be a CORS issue or the server is not running', 'warning');
                    log('api-test-results', 'Try switching to Local Development mode if testing locally', 'warning');
                }
            }
        }

        async function testTrackingEndpoint() {
            try {
                log('api-test-results', 'Testing tracking endpoint...');
                
                const testData = {
                    pageUrl: window.location.href,
                    referrer: document.referrer,
                    timestamp: Date.now(),
                    sessionData: {
                        id: 'test-session-123',
                        score: 50,
                        events: [
                            { type: 'test', timestamp: Date.now() }
                        ]
                    },
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                };
                
                const response = await fetch(API_ENDPOINT + '/track', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': 'test-session-123'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('api-test-results', `Tracking Endpoint Test Passed: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                }
            } catch (error) {
                log('api-test-results', `Tracking Endpoint Test Failed: ${error.message}`, 'error');
            }
        }

        async function testCORS() {
            try {
                log('api-test-results', 'Testing CORS configuration...');
                
                // Test with actual POST request instead of OPTIONS
                const testData = {
                    pageUrl: 'cors-test',
                    timestamp: Date.now(),
                    sessionData: { id: 'cors-test', score: 0 }
                };
                
                const response = await fetch(API_ENDPOINT + '/track', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });
                
                if (response.ok) {
                    log('api-test-results', 'CORS test passed - Cross-origin requests are allowed', 'success');
                    
                    // Try to check CORS headers if available
                    const corsHeaders = {
                        'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                        'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                        'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                    };
                    
                    if (corsHeaders['Access-Control-Allow-Origin']) {
                        log('api-test-results', `CORS Headers: ${JSON.stringify(corsHeaders, null, 2)}`, 'success');
                    }
                } else {
                    log('api-test-results', `CORS test failed with status: ${response.status}`, 'error');
                }
            } catch (error) {
                if (error.message.includes('Failed to fetch')) {
                    log('api-test-results', 'CORS Test Failed: Cross-origin requests may be blocked', 'error');
                    log('api-test-results', 'Note: This is expected when testing from file:// protocol. Deploy to a web server for accurate CORS testing.', 'warning');
                } else {
                    log('api-test-results', `CORS Test Error: ${error.message}`, 'error');
                }
            }
        }

        // Frontend tracking simulations
        function simulateEmergencyClick() {
            log('tracking-test-results', 'Simulating emergency click...');
            const event = new MouseEvent('click', { bubbles: true });
            const emergencyBtn = document.getElementById('emergency');
            emergencyBtn.dispatchEvent(event);
            log('tracking-test-results', 'Emergency click simulated (+30 points)', 'success');
            updateDebugPanel();
        }

        function simulatePhoneClick() {
            log('tracking-test-results', 'Simulating phone click...');
            const event = new MouseEvent('click', { bubbles: true });
            const phoneLink = document.getElementById('test-phone');
            phoneLink.dispatchEvent(event);
            log('tracking-test-results', 'Phone click simulated (+25 points)', 'success');
            updateDebugPanel();
        }

        function simulateFormEngagement() {
            log('tracking-test-results', 'Simulating form engagement...');
            const input = document.getElementById('test-input');
            input.focus();
            log('tracking-test-results', 'Form engagement simulated (+20 points)', 'success');
            updateDebugPanel();
        }

        function simulateMultiplePageViews() {
            log('tracking-test-results', 'Simulating multiple page views...');
            if (window.leadTracker) {
                window.leadTracker.trackPageView();
                window.leadTracker.trackPageView();
                log('tracking-test-results', 'Multiple page views simulated', 'success');
                updateDebugPanel();
            }
        }

        function checkTimeBasedScoring() {
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay();
            
            let timeScore = 0;
            let message = 'Current time scoring: ';
            
            if (hour < 8 || hour >= 18) {
                timeScore += 20;
                message += 'After hours (+20 points)';
            } else {
                timeScore += 5;
                message += 'Business hours (+5 points)';
            }
            
            if (day === 0 || day === 6) {
                timeScore += 10;
                message += ', Weekend (+10 points)';
            }
            
            log('tracking-test-results', message, 'success');
            log('tracking-test-results', `Total time-based score: ${timeScore} points`);
        }

        // Integration test
        async function runIntegrationTest() {
            const results = document.getElementById('integration-results');
            results.innerHTML = '<h3>Running Integration Tests...</h3>';
            
            console.log('Starting integration tests...');
            console.log('Current API_ENDPOINT:', API_ENDPOINT);
            console.log('window.leadTracker:', window.leadTracker);
            console.log('window.LeadTrackerClass:', window.LeadTrackerClass);
            
            // Ensure lead tracker is initialized
            if (!window.leadTracker && window.LeadTrackerClass) {
                console.log('Initializing lead tracker...');
                window.leadTrackerConfig.apiEndpoint = API_ENDPOINT;
                window.leadTracker = new window.LeadTrackerClass(window.leadTrackerConfig);
                // Wait a bit for initialization
                await new Promise(resolve => setTimeout(resolve, 100));
                console.log('Lead tracker initialized:', window.leadTracker);
            }
            
            const tests = [
                {
                    name: 'API Health Check',
                    test: async () => {
                        const response = await fetch(API_ENDPOINT + '/');
                        return response.ok;
                    }
                },
                {
                    name: 'Lead Tracker Initialization',
                    test: () => {
                        return window.leadTracker && window.leadTracker.session && window.leadTracker.session.id;
                    }
                },
                {
                    name: 'Event Tracking',
                    test: () => {
                        if (!window.leadTracker || !window.leadTracker.session) {
                            throw new Error('Lead tracker not initialized');
                        }
                        const initialEvents = window.leadTracker.session.events.length;
                        window.leadTracker.recordEvent('test', { data: 'test' });
                        return window.leadTracker.session.events.length > initialEvents;
                    }
                },
                {
                    name: 'Score Calculation',
                    test: () => {
                        if (!window.leadTracker || !window.leadTracker.session) {
                            throw new Error('Lead tracker not initialized');
                        }
                        const initialScore = window.leadTracker.session.score;
                        window.leadTracker.updateScore('behavior', 'phoneClick');
                        return window.leadTracker.session.score > initialScore;
                    }
                },
                {
                    name: 'Data Transmission',
                    test: async () => {
                        if (!window.leadTracker || !window.leadTracker.sendData) {
                            throw new Error('Lead tracker not initialized');
                        }
                        await window.leadTracker.sendData(true);
                        return true; // Will throw if fails
                    }
                }
            ];
            
            for (const test of tests) {
                console.log(`Running test: ${test.name}`);
                const result = document.createElement('div');
                
                try {
                    // Add timeout to prevent hanging
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Test timeout after 5 seconds')), 5000)
                    );
                    
                    const passed = await Promise.race([test.test(), timeoutPromise]);
                    
                    result.className = passed ? 'test-result test-pass' : 'test-result test-fail';
                    result.innerHTML = `
                        <span>${test.name}</span>
                        <span>${passed ? '✓ PASS' : '✗ FAIL'}</span>
                    `;
                    console.log(`Test ${test.name}: ${passed ? 'PASSED' : 'FAILED'}`);
                } catch (error) {
                    console.error(`Test ${test.name} error:`, error);
                    result.className = 'test-result test-fail';
                    result.innerHTML = `
                        <span>${test.name}</span>
                        <span>✗ FAIL: ${error.message}</span>
                    `;
                }
                
                results.appendChild(result);
            }
            
            console.log('Integration tests completed');
        }

        // Load test
        async function runLoadTest() {
            const count = parseInt(document.getElementById('load-test-count').value);
            const results = document.getElementById('load-test-results');
            results.innerHTML = '';
            results.style.display = 'block';
            
            log('load-test-results', `Starting load test with ${count} requests...`);
            
            const startTime = Date.now();
            const promises = [];
            
            for (let i = 0; i < count; i++) {
                const promise = fetch(API_ENDPOINT + '/track', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': `load-test-${i}`
                    },
                    body: JSON.stringify({
                        pageUrl: window.location.href,
                        timestamp: Date.now(),
                        sessionData: { id: `load-test-${i}`, score: Math.random() * 100 }
                    })
                });
                promises.push(promise);
            }
            
            try {
                const results = await Promise.allSettled(promises);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                const successful = results.filter(r => r.status === 'fulfilled' && r.value.ok).length;
                const failed = count - successful;
                
                log('load-test-results', `Load test completed in ${duration}ms`, 'success');
                log('load-test-results', `Successful requests: ${successful}/${count}`);
                log('load-test-results', `Failed requests: ${failed}/${count}`);
                log('load-test-results', `Average response time: ${(duration / count).toFixed(2)}ms per request`);
                
                if (failed > 0) {
                    log('load-test-results', 'Some requests failed. Check API logs for details.', 'error');
                }
            } catch (error) {
                log('load-test-results', `Load test failed: ${error.message}`, 'error');
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize lead tracker with correct endpoint
            if (window.LeadTrackerClass) {
                window.leadTrackerConfig.apiEndpoint = API_ENDPOINT;
                window.leadTracker = new window.LeadTrackerClass(window.leadTrackerConfig);
            }
            // Run initial API health check
            testAPIHealth();
        });

        // Prevent form submission
        document.getElementById('test-form').addEventListener('submit', (e) => {
            e.preventDefault();
            log('tracking-test-results', 'Test form submitted (prevented default)', 'success');
        });
    </script>
</body>
</html>